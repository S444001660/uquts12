# مدير المعامل - Lab Manager

تطبيق لإدارة معامل جامعة أم القرى

An application for managing Umm Al-Qura University labs

## 🌟 المميزات | Features

- ✨ تسجيل المعامل وإدارتها | Register and manage labs
- 📱 تسجيل الأجهزة وربطها بالمعامل | Register devices and link them to labs
- 📷 مسح الباركود للأجهزة | Scan device barcodes
- 🔍 البحث والتصفية | Search and filter
- 📊 إحصائيات وتقارير | Statistics and reports

## 🚀 التثبيت | Installation

1. تأكد من تثبيت Flutter SDK | Make sure Flutter SDK is installed
2. قم بتنزيل المشروع | Clone the project
```bash
git clone https://github.com/yourusername/lab-manager.git
```
3. قم بتثبيت التبعيات | Install dependencies
```bash
flutter pub get
```
4. قم بتشغيل التطبيق | Run the app
```bash
flutter run
```

## 📱 متطلبات النظام | System Requirements

- Flutter 3.0.0 أو أحدث | or newer
- Dart 3.0.0 أو أحدث | or newer
- Android Studio / VS Code
- Android SDK / Xcode

## 🔧 الإعداد | Setup

1. قم بإنشاء مشروع في Firebase | Create a Firebase project
2. قم بتحميل ملف google-services.json | Download google-services.json
3. ضع الملف في المسار | Place the file in:
   - Android: `android/app/google-services.json`
   - iOS: Update Firebase settings in Xcode

## 📄 الترخيص | License

هذا المشروع مرخص تحت رخصة MIT | This project is licensed under the MIT License

## 👥 المساهمة | Contributing

نرحب بمساهماتكم! | We welcome your contributions!

1. Fork المشروع | Fork the project
2. إنشاء فرع للميزة | Create a feature branch
3. Commit التغييرات | Commit your changes
4. Push إلى الفرع | Push to the branch
5. فتح Pull Request | Open a Pull Request

شاشة ماسح الباركود (BarcodeScannerScreen)

📝 نظرة عامة
تعمل هذه الشاشة كبوابة رئيسية لتسجيل ومتابعة الأجهزة عبر مسح الباركود. تستخدم كاميرا الجهاز لاكتشاف الباركود، ثم تتخذ قرارًا ذكيًا بناءً على ما إذا كان الجهاز مسجلاً في قاعدة البيانات أم لا. تم تصميم الشاشة للتحكم الدقيق في دورة حياة الماسح الضوئي لضمان تجربة مستخدم سلسة وموثوقة.

🌊 تدفق البيانات (Data Flow)
يتبع تدفق البيانات والتحكم في هذه الشاشة تسلسلاً منطقياً يضمن معالجة كل باركود بشكل صحيح.

1. التحميل والتهيئة (Loading and Initialization)
   الزناد: عند فتح الشاشة، يتم استدعاء دالة initState.

الإجراء:

* تُستدعى \_loadLabs() لجلب قائمة المعامل المتاحة من Firebase بشكل غير متزامن. يتم عرض مؤشر تحميل (\_isLoading) أثناء هذه العملية.
* في نفس الوقت، تُستدعى \_startScanner() لبدء تشغيل الكاميرا والماسح الضوئي بشكل صريح، حيث تم تعطيل التشغيل التلقائي (autoStart: false).

النتيجة: يرى المستخدم واجهة الكاميرا جاهزة للمسح فوراً، بينما يتم تحميل قائمة المعامل في الخلفية لاستخدامها لاحقاً إذا لزم الأمر.

2. اكتشاف الباركود ومعالجته (Barcode Detection & Handling)
   الزناد: عندما تكتشف الكاميرا باركوداً، يتم تفعيل onDetect الذي يستدعي بدوره الدالة المحورية \_handleBarcodeScan.

الإجراء داخل \_handleBarcodeScan:

* إيقاف الماسح: أول خطوة هي استدعاء \_stopScanner() لإيقاف الكاميرا ومنع اكتشاف نفس الباركود عدة مرات أثناء المعالجة.
* تحليل البيانات: يتم استخلاص بيانات الباركود الأول وتحليلها باستخدام BarcodeUtils.
* التحقق من قاعدة البيانات: تُستدعى \_checkDeviceExists() للبحث في Firebase عن جهاز يطابق بيانات الباركود.

النتيجة: يتفرع مسار عمل التطبيق بناءً على نتيجة البحث.

3. تفرع المسار (Path Bifurcation)

* إذا كان الجهاز موجوداً: تُستدعى دالة \_showExistingDeviceDialog.
* إذا كان الجهاز غير موجود: تُستدعى دالة \_navigateToNewDeviceRegistration.

4. معالجة النتائج وإعادة التشغيل (Result Handling & Scanner Restart)

* مسار الجهاز الموجود:

  * يظهر مربع حوار AlertDialog يعرض اسم الجهاز وزراً للانتقال إلى تفاصيله.
  * عند الضغط على الزر، ينتقل المستخدم إلى شاشة ViewDeviceScreen.
  * الأهم: عند إغلاق مربع الحوار أو العودة من شاشة التفاصيل، يتم استدعاء \_startScanner() من خلال .then() لإعادة تنشيط الكاميرا وتجهيزها لمسح جديد.

* مسار الجهاز الجديد:

  * ينتقل المستخدم مباشرة إلى شاشة AddDeviceScreen.
  * يتم تمرير بيانات الباركود (scannedBarcodeData) إلى الشاشة الجديدة لملء الحقول المتعلقة بالأصل تلقائياً.
  * الأهم: عند الانتهاء من إضافة الجهاز والعودة من شاشة AddDeviceScreen، يتم استدعاء \_startScanner() من خلال .then() لإعادة تنشيط الكاميرا.

🎭 سيناريوهات الاستخدام (Usage Scenarios)

1. مسح باركود لجهاز مسجل مسبقًا
   الوصف: يقوم المستخدم بمسح باركود جهاز موجود بالفعل في النظام للوصول إلى معلوماته بسرعة.
   الخطوات:

* يفتح المستخدم الماسح ويوجهه نحو الباركود.
* يكتشف التطبيق الباركود ويتحقق من قاعدة البيانات ويجد تطابقاً.
* يظهر مربع حوار يؤكد وجود الجهاز.
* يضغط المستخدم على "عرض تفاصيل الجهاز" للانتقال إلى شاشة العرض.
  النتيجة: وصول سريع لمعلومات الجهاز. عند العودة، يكون الماسح جاهزاً للعمل مرة أخرى.

2. مسح باركود لتسجيل جهاز جديد
   الوصف: يقوم المستخدم بمسح باركود جهاز غير مسجل في النظام بهدف إضافته.
   الخطوات:

* يوجه المستخدم الكاميرا نحو باركود جديد.
* يكتشف التطبيق الباركود ويبحث في قاعدة البيانات ولا يجد تطابقاً.
* يتم نقل المستخدم تلقائياً إلى شاشة AddDeviceScreen.
* تكون حقول مثل "الرقم التسلسلي" و"رمز الأصل" مملوءة مسبقاً.
* يكمل المستخدم باقي البيانات (اسم الجهاز، الموديل، ويختار المعمل) ثم يحفظ.
  النتيجة: عملية إضافة جهاز جديد سريعة ودقيقة، تقلل من أخطاء الإدخال اليدوي.

⚙️ التحكم بالماسح الضوئي (Scanner Control)
تم تصميم هذه الشاشة للتحكم اليدوي الكامل في الماسح الضوئي عبر:

* autoStart: false: لضمان عدم بدء تشغيل الكاميرا إلا عند الطلب.
* \_startScanner(): دالة مخصصة لبدء تشغيل الماسح.
* \_stopScanner(): دالة مخصصة لإيقاف الماسح.

هذا التحكم ضروري لمنع المشاكل الشائعة مثل معالجة نفس الباركود عدة مرات، ولضمان تحرير موارد الكاميرا عند إغلاق الشاشة أو الانتقال إلى شاشة أخرى، مما يحسن أداء التطبيق ويحافظ على البطارية.

🛠️ الدوال الرئيسية ووظائفها

* \_loadLabs: تجلب قائمة المعامل من Firebase لاستخدامها عند تسجيل جهاز جديد.
* \_startScanner / \_stopScanner: تدير دورة حياة الكاميرا بشكل دقيق.
* \_handleBarcodeScan: هي المنسق الرئيسي الذي يتم استدعاؤه عند اكتشاف باركود، وتقوم بتوجيه البيانات إلى المسار الصحيح.
* \_checkDeviceExists: تتواصل مع قاعدة البيانات للتحقق من وجود الجهاز.
* \_showExistingDeviceDialog: تدير واجهة المستخدم في حالة العثور على جهاز موجود.
* \_navigateToNewDeviceRegistration: تدير واجهة المستخدم في حالة عدم العثور على الجهاز.
* build: تبني واجهة المستخدم، وتعرض إما مؤشر تحميل أو واجهة الكاميرا مع أزرار التحكم بالفلاش والكاميرا.
